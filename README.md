# UCS Exploit
A program that crashes Ultrapowa Clash Servers written in C#.
[UcsDowner](https://github.com/RedMoonDevs/UcsDowner) does practically the same thing but its written by the guys at RedMoon and in Java.

I dug around the source code of [ucs](https://github.com/Ultrapowa/UCS) and found a vulnerability which allows a remote
logged in attacker to cause a StackOverflowException with the [ExecuteCommandsMessage](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Messages/Client/ExecuteCommandsMessage.cs)
and [FreeWorkCommand](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/FreeWorkerCommand.cs).

## Details
In the Clash of Clans protocol, the [ExecuteCommandsMessage](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Messages/Client/ExecuteCommandsMessage.cs)
allows you to send a list of commands to the server, such as [BuyBuildingCommand](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/BuyBuildingCommand.cs)
which tells the server that you bought a building and the server checks if you have enough resources available to do so then
it places the building in your village.

In the UCS implementation, you are allowed to send embedded commands inside of the [FreeWorkerCommand](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/FreeWorkerCommand.cs).
As you can send an embedded command inside of it you can embed another [FreeWorkerCommand](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/FreeWorkerCommand.cs)
inside of it and this is where the vulnerability is.

In this case here is what is generated by the program.

```javascript
FreeWorkerCommand
{
    m_vTimeLeftSeconds = 1337
    m_vIsCommandEmbedded = 1
    m_vCommand = FreeWorkerCommand
    {
        m_vTimeLeftSeconds = 1337
        m_vIsCommandEmbedded = 1
        m_vCommand = FreeWorkerCommand
        {
            ...
            m_vCommand = FreeWorkerCommand
            {
                ...
                m_vCommand = FreeWorkerCommand
                {
                   ...
                   m_vCommand = FreeWorkerCommand
                   {
                        //1000 more nested command
                        ...
                   } 
                }
            }
        }
    }
}
```

If you create a [FreeWorkerCommand](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/FreeWorkerCommand.cs)
which contains a lot of nested [FreeWorkerCommands](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/Commands/FreeWorkerCommand.cs)
then when the server reads it, it will stress out and cause a StackOverflowException by making a lot of calls to 
[CommandFactory.Read](https://github.com/Ultrapowa/UCS/blob/92b91b6424f00abe4e14e3817dc94eb8b6dbb752/Ultrapowa%20Clash%20Server/PacketProcessing/CommandFactory.cs#L67-L83).

### Demonstration
You can watch a demo of the attack [here](https://www.youtube.com/watch?v=zNM8DzJc0zg).

### Fixing
This can fixed by simpling adding a reading depth limitation.

## Usage
Here is example usage of how you should use it.

```
[mono] ucs-exploit.exe -s 5000 127.0.0.1
```

Printing help will display all the available options.

```
[mono] ucs-exploit.exe -h
```